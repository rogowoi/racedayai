generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(cuid())
  name                   String?
  email                  String    @unique
  emailVerified          DateTime?
  image                  String?
  passwordHash           String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  plan                   String    @default("free")
  plansCreatedThisSeason Int       @default(0)
  seasonStartDate        DateTime?
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  accounts               Account[]
  athletes               Athlete?
  sessions               Session[]

  @@index([stripeCustomerId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Athlete {
  id               String                   @id @default(cuid())
  userId           String                   @unique
  garminConnected  Boolean                  @default(false)
  garminToken      Json?
  stravaConnected  Boolean                  @default(false)
  stravaToken      Json?
  ftpWatts         Int?
  thresholdPaceSec Int?
  cssPer100mSec    Int?
  maxHr            Int?
  restingHr        Int?
  weightKg         Decimal?                 @db.Decimal(5, 1)
  experienceLevel  String                   @default("beginner")
  gender           String?
  sweatRateMlHr    Int?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  racePlans        RacePlan[]
  trainingFeatures AthleteTrainingFeature[]

  @@index([userId])
}

model RaceCourse {
  id                 String     @id @default(cuid())
  raceName           String
  raceYear           Int?
  distanceCategory   String
  location           String?
  latitude           Decimal?   @db.Decimal(9, 6)
  longitude          Decimal?   @db.Decimal(9, 6)
  swimDistanceM      Int?
  bikeDistanceM      Int?
  runDistanceM       Int?
  bikeGpxUrl         String?
  runGpxUrl          String?
  bikeElevationGainM Int?
  runElevationGainM  Int?
  courseNotes        String?
  createdAt          DateTime   @default(now())
  racePlans          RacePlan[]

  @@index([raceName, raceYear])
}

model RacePlan {
  id                 String        @id @default(cuid())
  athleteId          String
  courseId           String
  raceDate           DateTime      @db.Date
  status             String        @default("completed") // pending | generating | completed | failed
  errorMessage       String?
  generationInput    Json?         // Stores wizard inputs for async processing
  gpxFileKey         String?       // R2 object key for uploaded GPX
  goalType           String        @default("finish_strong")
  weatherData        Json?
  altitudeM          Int?
  swimPlan           Json?
  bikePlan           Json?
  runPlan            Json?
  nutritionPlan      Json?
  transitionPlan     Json?
  statisticalContext Json?         // Data-driven cohort analysis (840K records)
  predictedFinishSec Int?
  confidenceLowSec   Int?
  confidenceHighSec  Int?
  predictedSplits    Json?
  narrativePlan      String?
  weatherWarnings    String[]
  pdfUrl             String?
  shareToken         String?       @unique @db.VarChar(12)
  createdAt          DateTime      @default(now())
  athlete            Athlete       @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  course             RaceCourse    @relation(fields: [courseId], references: [id])
  planOutcomes       PlanOutcome[]

  @@index([athleteId, raceDate(sort: Desc)])
  @@index([shareToken])
}

// ─── Statistical Data Tables ───────────────────────────────────

model RaceResult {
  id                String   @id @default(cuid())
  gender            String?
  ageGroup          String?
  age               Int?
  country           String?
  eventYear         Int
  eventLocation     String?
  swimTimeSec       Float
  bikeTimeSec       Float
  runTimeSec        Float
  transitionTimeSec Float?
  totalTimeSec      Float
  source            String   @default("kaggle")
  createdAt         DateTime @default(now())

  @@index([eventYear, eventLocation])
  @@index([gender, ageGroup])
}

model CohortDistribution {
  id         String   @id @default(cuid())
  gender     String
  ageGroup   String
  distance   String
  discipline String
  mu         Float
  sigma      Float
  n          Int
  p10        Float
  p25        Float
  p50        Float
  p75        Float
  p90        Float
  updatedAt  DateTime @updatedAt

  @@unique([gender, ageGroup, distance, discipline])
  @@index([gender, ageGroup])
}

model WeatherRecord {
  id            String    @id @default(cuid())
  eventLocation String
  eventYear     Int
  eventDate     DateTime?
  tempC         Float?
  humidityPct   Float?
  windKph       Float?
  conditions    String?
  source        String?
  createdAt     DateTime  @default(now())

  @@index([eventYear, eventLocation])
}

model PlanOutcome {
  id                String   @id @default(cuid())
  planId            String
  actualSwimSec     Float?
  actualBikeSec     Float?
  actualRunSec      Float?
  actualTotalSec    Float?
  weatherConditions String?
  reportedAt        DateTime
  createdAt         DateTime @default(now())
  plan              RacePlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

model AthleteTrainingFeature {
  id           String   @id @default(cuid())
  athleteId    String
  periodStart  DateTime
  weeklyTssAvg Float?
  longRideHrs  Float?
  longRunKm    Float?
  ftpTrend     Float?
  volumeTrend  Float?
  createdAt    DateTime @default(now())
  athlete      Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId, periodStart(sort: Desc)])
}
